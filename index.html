<script>
document.addEventListener('DOMContentLoaded', () => {
  // üîë Conexi√≥n a Supabase
  const supabaseUrl = 'https://pn0jdukyo4rjosjtehwr.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBuYmp1ZGt5dWpvaXFzamhlaHhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNzc1NTYsImV4cCI6MjA3Nzk1MzU1Nn0.uUyNaDpzEtSJPJ_utOdOQLMS9bNEg0MtGjQip0vHXx4'; // ‚Üê pega tu clave completa
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser = "";

  const loginBtn = document.getElementById('login-btn');
  const usernameInput = document.getElementById('username');
  const loginSection = document.getElementById('login-section');
  const forumSection = document.getElementById('forum-section');
  const form = document.getElementById('form');
  const posts = document.getElementById('posts');

  loginBtn.addEventListener('click', () => {
    currentUser = usernameInput.value.trim();

    if (currentUser !== "") {
      loginSection.style.display = 'none';
      forumSection.style.display = 'block';
      cargarPosts();
    } else {
      alert("Por favor, ingresa tu nombre de usuario.");
    }
  });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const mensaje = document.getElementById('mensaje').value;
    const imagenInput = document.getElementById('imagen');
    const imagen = imagenInput.files[0];

    if (!mensaje.trim()) {
      alert("El mensaje no puede estar vac√≠o.");
      return;
    }

    let imagenBase64 = null;

    if (imagen) {
      const reader = new FileReader();
      reader.onload = async function(event) {
        imagenBase64 = event.target.result;
        await guardarPost(mensaje, imagenBase64);
      };
      reader.readAsDataURL(imagen);
    } else {
      await guardarPost(mensaje, null);
    }

    form.reset();
  });

  async function guardarPost(mensaje, imagenBase64) {
    const fecha = new Date().toISOString();

    const { error } = await supabase
      .from('posts')
      .insert([{ usuario: currentUser, mensaje: mensaje, imagen: imagenBase64, fecha: fecha }]);

    if (error) {
      console.error("Error al guardar:", error);
      alert("Hubo un problema al publicar.");
    } else {
      cargarPosts();
    }
  }

  async function cargarPosts() {
    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .order('id', { ascending: false });

    if (error) {
      console.error("Error al cargar:", error);
      return;
    }

    posts.innerHTML = `<h2>Publicaciones recientes (${data.length})</h2>`;
    data.forEach(post => {
      const div = document.createElement('div');
      div.className = 'post';

      const fechaFormateada = post.fecha
        ? new Date(post.fecha).toLocaleString('es-MX', { dateStyle: 'medium', timeStyle: 'short' })
        : 'Sin fecha';

      div.innerHTML = `<strong>${post.usuario}</strong><p>${post.mensaje}</p><small>${fechaFormateada}</small>`;
      if (post.imagen) {
        const img = document.createElement('img');
        img.src = post.imagen;
        div.appendChild(img);
      }
      posts.appendChild(div);
    });
  }
});
</script>
